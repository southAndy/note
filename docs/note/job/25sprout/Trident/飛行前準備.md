
#trident



- [x] 工具安裝： ✅ 2025-03-25
	- [x] ⏳ 2025-03-20 Orbstack ✅ 2025-03-20
	- [x] 📅 2025-03-20 AWS CLI ✅ 2025-03-20
	- [x] 📅 2025-03-20 下載 Pritual Client ✅ 2025-03-24
- [x] 三宏相關帳號開通： ⏫ 🛫 2025-03-24 ✅ 2025-03-25
- [x] 前置作業： 🛫 2025-03-20 ✅ 2025-03-25
	- [x] aws 操作 ✅ 2025-03-24
		- [x] `aws configure` : 缺三宏提供(id:[已移除] / key:[已移除]) + default region name: ✅ 2025-03-24
		- [x] `$ aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin [689083824683.dkr.ecr.ap-northeast-1.amazonaws.com](http://689083824683.dkr.ecr.ap-northeast-1.amazonaws.com/)`：指令拆解看註一 ✅ 2025-03-24
	- [x] 註冊 mailtrap ✅ 2025-03-24





## 註解

### 註解一

```shell
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin [689083824683.dkr.ecr.ap-northeast-1.amazonaws.com](http://689083824683.dkr.ecr.ap-northeast-1.amazonaws.com/)
```

拆解指令為：

1. `aws ecr get-login-password --region ap-northeast-1`  
    這部分使用 AWS CLI 指令來取得位於亞太區（東京或其他 ap-northeast-1 區域）的 ECR 登入密碼。該指令會回傳一個密碼字串，該字串可用於 Docker 登入。
    
- `|` (管道符號)
    管道符號會**把前面指令的輸出直接傳給**後面的指令作為輸入，不需要中間存檔。
    
- `docker login --username AWS --password-stdin 689083824683.dkr.ecr.ap-northeast-1.amazonaws.com`  
    Docker 登入指令使用 `--password-stdin` 選項從標準輸入讀取密碼。使用者名稱固定為 `AWS`（這是 AWS ECR 登入時的規範），而後面的網址則是目標 ECR Registry 的位址。
    

整體來說，這個指令的流程是：

1. 從 AWS 取得登入密碼
2. 將該密碼傳給 Docker
3. Docker 使用該密碼登入到指定的 AWS ECR 服務

這樣一來，你就可以使用 Docker 指令（例如 pull 或 push）來存取該 ECR 中的映像檔了。

----

## 建置 CMS 專案

1.設定各種服務 `port` ：進到 `/.devcontainer/.env` 設定，我是使用 AI 幫忙隨機產生
2.建立 `docker-compose.override.yml` ：覆蓋他們預設的 yml ，因為三宏環境是 windows，但是我們是 macOS，覆蓋配置內容如下：

```shell
version: "3.1" 
services: 
  mysql-test: 
	platform: linux/amd64 
  mysql: 
	platform: linux/amd64 
  php-fpm: 
	platform: linux/amd64 
	environment: 
		- NPM_TOKEN={你在 gitlab 產生的 access token } 
	extra_hosts: 
		- "host.docker.internal:host-gateway"
```

3.執行 `./oconf start`  這樣就能成功啟動專案容器內的服務，記得打開 orbStack ，執行後就會出現服務：

![[Pasted image 20250325175123.png]]

3.接著執行 `./oconf devcontainer bash`  進到容器內
4.執行 `./oconf init` 來初始化這個專案，**具體來說會產生前後端、strapi 內的 `.env`**，會提示你輸入：`userName` （通常是公司信箱）、 `password`:你透過 personal aceess token 產生的隨機值，來繼續往下執行，過程如果產生下方紅字訊息，是因為專案內的連動環境變數尚未設定
![[Pasted image 20250325103738.png]]

但是不論是否有紅字都會運行完，接下來我們回頭去把上述紅字警告內的環境變數一一補上



### 啟動後台

#### /backend 環境變數

下方寫 `{}` 則是代表由我們（開發者）去自行產生

```
//.env
APP_KEY={} #參考 notion 第九步驟來產生


# for frontend with shared db
DB_HOST=awsdevdb.7nm.org
DB_PORT=3306
DB_DATABASE=cms_dev

DB_USERNAME={} #由三宏人員提供
DB_PASSWORD={} #由三宏人員提供

# for frontend with shared db
STRAPI_DB_HOST=awsdevdb.7nm.org
STRAPI_DB_PORT=3306
STRAPI_DB_DATABASE=cms_dev_strapi

STRAPI_DB_USERNAME={} #由三宏人員提供
STRAPI_DB_PASSWORD={} #由三宏人員提供

# use your own mailtraip 
# (登入 mailtrap 中 home 頁面選擇 testing email 選項，就會提供以下選項)

MAIL_MAILER=smtp
MAIL_HOST={}
MAIL_PORT={}
MAIL_USERNAME={}
MAIL_PASSWORD={}
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS={}
MAIL_FROM_NAME="${APP_NAME}"


# dev see BW [CMS][dev] AWS credentials
AWS_ACCESS_KEY_ID={} #bitwarden 取得
AWS_SECRET_ACCESS_KEY={}

# see [CMS][DEV] weblate token (password)
# or use your own token in API access(訪問後面那個連結登入後取得) https://weblate.outland.tw/accounts/profile/#api

WEBLATE_ACCESS_TOKEN={} #訪問上面連結登入後取得，帳密可參考 notion / others

# strapi

# see ./oconf devcontainer print, should be like http://localhost:40112, no /admin or /graphql

STRAPI_URL={} #參考 .devcontainer 的變數值

# go to admin panel /admin/settings/api-tokens?sort=name:ASC and generate token with
# Name: [YOUR NAME] Laravel Backend
# Token duration: Unlimited
# Token Type: Full Access

# ----STRAPI_TOKEN 這個值要透過在本地端啟動 strapi 服務後取得，所以到這邊要先去完成 /strapi/.env 的內容 ----- #
STRAPI_TOKEN={} 


#book
BOOK_BASE_URL=https://[IBE_BE_URL] 
BOOK_SYSTEM_ID={} #啟動專案前可以先寫死為 1 ，之後補回來
BOOK_API_KEY={}  #啟動專案前可以先寫死為 xxx ，之後補回來

#Club create openid connect implicit client command and get client id https://kb.travelskope.com/doc/auth-sso-command-6EDVu5Ipv5#h-club-%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A
CLUB_CLIENT_ID={} #啟動專案前可以先寫死為 1 ，之後補回來

```

所以先來建置 /strapi 的環境變數

#### /strapi 環境變數

```
# for frontend with shared db
DATABASE_USERNAME={} #三宏提供
DATABASE_PASSWORD={} #三宏提供

# should be backend laravel url
# e.g. http://localhost:3AABB or http://awsdev[N].7nm.org:3AABB or https://cms-api.stage.com
PLUGIN_LARAVEL_CHANNEL_ORIGIN={} # 對到 API_SERVER_PORT 值

# dev see BW [CMS][dev][strapi] AWS credential
AWS_ACCESS_KEY_ID={} #bitwarden
AWS_SECRET_ACCESS_KEY={} #bitwarden

# should be backend laravel url
# e.g. http://localhost:3AABB or http://awsdev[N].7nm.org:3AABB or https://cms-api.stage.com

BACKEND_BASE_URL={} # 對到 API_SERVER_PORT 值

# generate by running `php artisan internal-api-auth:add-system {Your name}` (dev)

BACKEND_SYSTEM_ID={}

BACKEND_API_KEY={}
```

#### BACKEND_SYSTEM_ID / API_KEY

移動至 `/backend` 層級執行

```shell
php artisan internal-api-auth:add-system {Your name}
```

這個指令是 Laravel 的 artisan 指令，用於在系統中新增一個內部 API 認證的系統使用者，完成後會出現類似下圖

![[Pasted image 20250325142838.png]]

回去填寫對應的變數中，接著嘗試執行 `./oconf watch-strapi` 啟動 strapi 的服務，登入後進到以下畫面

![[Pasted image 20250326105122.png]]

建立一組 token 給 後端的 `STRAPI_TOKEN` 使用

> 記得產生完 token 要立刻記錄下來，離開頁面後再回來就無法檢視了





#### 嘗試啟動

維持 strapi 服務啟動狀態，嘗試前往 

```
 http://localhost:{API_SERVER_PORT}/admin/login
```

成功的話會出現登入介面，輸入完帳密後會接著要求輸入 TOTP ，去 mailtrap 裡面收 TOTP 並輸入。

![[Pasted image 20250325145000.png]]

到目前為止你就成功啟動 cms 的後台部分，接下來進到前台的啟動部分。


### 啟動前台流程
前面有提到，新芽這邊額外有寫一個 `yml` 去覆蓋預設容器配置，其中包含**本地轉址設定**，會將 `localhost => host.docker.internal` ，所以要將 `/frontend/.env` 內部的本地網址變數全部改寫，在前端環境變數比較複雜的就是：

1. `STRAPI_ACCESS_TOKEN`
2. `LANG_FILE_API_URL` 

```
FRONTEND_BASE_URL={} # localhost => extra_hosts
FRONTEND_DEV_HMR_PORT={}  #參考 .devcontainer/.env
SSR_SERVER_PORT={} #參考 .devcontainer/.env

# API from strapi (should ./oconf watch-strapi before fetching)
STRAPI_GRAPHQL_BASE_URL={} # localhost => extra_hosts 參考 .devcontainer/.env
BACKEND_GRAPHQL_BASE_URL={} # localhost => extra_hosts 參考 .devcontainer/.env

# go to strapi admin panel {STRAPI_URL in backend/.env}/admin/settings/api-tokens?sort=name:ASC and generate token with
# Name: [YOUR NAME] Frontend
# Token duration: Unlimited
# Token Type: Read-only

# SHOULD BE GENERATED IN CORRECT ENVIROMENT ADMIN (ref: https://kb.travelskope.com/doc/cms-strapi-graphql-reference-pjX5Lr4HZs)

STRAPI_ACCESS_TOKEN={}


# API from weblate
# go to your admin panel i18n management http://[YOUR_HOST]:[YOUR_API_SERVER_PORT_IN_DEVCONTAINER_ENV]/weblate-companion/components#active-menu
# copy data-url from CMS Frontend Translations button "複製語言檔 api 網址" (should get data-url from dev-tool if your are in dev)
# the url may like this: http://[YOUR_HOST]:[YOUR_API_SERVER_PORT_IN_DEVCONTAINER_ENV]/weblate-companion/components/cms-dev-frontend/language-file-url/zh-TW
# replace the locale partial with __LANGUAGE__ e.g. http://[YOUR_HOST]:[YOUR_API_SERVER_PORT_IN_DEVCONTAINER_ENV]/weblate-companion/components/cms-dev-frontend/language-file-url/__LANGUAGE__

LANG_FILE_API_URL={}

```

#### STRAPI_ACCESS_TOKEN
在前面我們完成 /strapi 的環境變數設定後，可以使用指令啟動、並登入 /strapi 的後台（如下圖），這個參數就是在這裡產生

![[Pasted image 20250326105122.png]]

使用右上角的 **Create new API Token** 產生 token ，接著將 token 填回該變數內

> 記得產生完 token 要立刻記錄下來，離開頁面後再回來就無法檢視了

#### LANG_FILE_API_URL
這個網址取得方式，你要先進入你本機啟動的 cms 後台，找左側欄位的 `/settings` 即可取得

![[Pasted image 20250326105807.png]]

到這一步驟你目前能填寫的環境變數應該都填寫了，試著執行 `./oconf watch` 後，打開 http://host.docker.internal:{YOUR_PORT}/zh-TW/index 應該會發現空白畫面，這是因為 **你還要設定本機位置指向 host.docker.internal**。

> docker-composer 內撰寫的轉址腳本，因為 version 太舊所以失效，要額外手動設定

```shell
sudo sh -c "echo '127.0.0.1 host.docker.internal' >> /etc/hosts
```

檢查是否生效，可以去檢視 `hosts` 檔案內容

```shell
cd /etc
cat hosts
```

看到這樣就是成功了

![[Pasted image 20250326110459.png]]

再嘗試點一次本地前端網址，能看到畫面跑出來就行，目前 network 那邊狂報錯是正常的？


----

## CLUB

下載 repo 很簡單，所以省略

