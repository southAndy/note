
#bms 




## 本地




## 遠端伺服器

### 如何進入

將開發用電腦的公鑰存入遠端伺服器的驗證檔中，之後直接下以下指令
```shell
ssh lsdev@172.104.68.21
```

就能登入遠端伺服器應該會看到這樣：
![[Pasted image 20230607141829.png]]

### 如何退出

```shell
control + D
```


### 測試機的 nginx 配置位置

```shell
/etc/nginx/sites-available
```

---
## 部署到遠端伺服器

### 部署指令

```shell
"tar zcvf leishan_bms.tar.gz ./dist && ssh lsdev@172.104.68.21 'rm -rf ~/projects/leishan_bms_feature_`date +%F`' && ssh lsdev@172.104.68.21 'mv ~/projects/leishan_bms_feature/* ~/projects/leishan_bms_feature_`date +%F`' && scp leishan_bms.tar.gz lsdev@172.104.68.21:~/projects && ssh lsdev@172.104.68.21 'tar zxvf ~/projects/leishan_bms.tar.gz -C ~/projects/leishan_bms_feature'"
```
 > `&&` 在 *shell script* 是一個串聯符，表示第一個指令成功執行後，才會繼續執行後續的指令，若失敗則會終止執行

#### 解析部署指令
這一串指令實際上執行以下內容：

1.  將 `./dist` 資料夾歸檔 (`tar`) 成名為 `leishan_bms.tar.gz` 的檔案
```shell
"tar zcvf leishan_bms.tar.gz ./dist"
```

2. 使用 ssh 連線到專案對應的遠端伺服器
```shell
"ssh lsdev@172.104.68.21"
```
3. 刪除指定路徑的目錄
```shell
'rm -rf ~/projects/leishan_bms_`date +%F`'
```
> 'date +%F' 是替換指令，用於獲取執行指令當下的日期，格式為 YYYY-MM-DD
<br>
4. 會先連線遠端伺服器，==將舊的部署進度（/dist）存入其他目錄（做為備份）==

```shell
"ssh lsdev@172.104.68.21"
"`'mv ~/projects/leishan_bms_feature/* ~/projects/leishan_bms_feature_`date +%F`'`"
```

6. 使用 `scp` （安全複製指令） 將本地壓縮檔案複製到遠端伺服器的指定位置
```shell
"scp leishan_bms.tar.gz lsdev@172.104.68.21:~/projects"
```

5. 再次連線至遠端伺服器，將本地壓縮檔解壓縮至指定目錄（此以 feature 機為例，就是解壓至 leishan_bms_feature）
```shell
"ssh lsdev@172.104.68.21" 
"tar zxvf ~/projects/leishan_bms.tar.gz -C ~/projects/leishan_bms_feature"
```


---
## 遠端伺服器的目錄架構

```
/projects
	- backup_projects
	- leishan_bms //用來存放 stage dist
	- leishan_bms_feature //用來存放 feature dist
	- leishan_bms_YYYY-MM-DD // stage 前一版本專案備份 dist
	- leishan_bms_feature_YYYY-MM-DD //feature 前一版本專案備份 dist
```
